# RTF优化说明

## 问题描述
单独运行时RTF能稳定在1以下，但和其他服务一起运行时RTF在1-2之间，说明资源竞争导致性能下降。

## 优化方案

### 1. 优化文本分割策略

**修改文件**: `cosyvoice/cli/frontend.py`

**优化内容**:
- 启用逗号分割 (`comma_split=True`): 允许在逗号处分割，更细粒度地按句子边界分割
- 调整分割参数:
  - `token_max_n`: 80 → 70 (减少最大长度，更频繁分割)
  - `token_min_n`: 60 → 50 (减少最小长度，允许更小的chunk)
  - `merge_len`: 20 → 15 (减少合并阈值，避免过长的句子)

**效果**: 
- 文本在进入流式处理前就已经按句子边界（包括逗号和句号）分割好
- 避免在流式处理时打断一句话，提高语音质量
- 更小的chunk可以减少单次处理时间，降低RTF

### 2. 自适应Chunk大小调整

**修改文件**: `cosyvoice/cli/model.py` (CosyVoice2Model.tts方法)

**优化内容**:
- 添加自适应chunk大小机制:
  - 初始chunk大小: `token_hop_len` (25)
  - 最小chunk大小: `token_hop_len // 2` (12)
  - 最大chunk大小: `token_hop_len * 2` (50)
- 根据处理时间动态调整:
  - 如果平均处理时间 > 0.1秒: 减小chunk大小 (乘以0.8)
  - 如果平均处理时间 < 0.05秒: 增大chunk大小 (乘以1.1)
- 记录最近5次的处理时间，用于自适应调整

**效果**:
- 在资源竞争时自动使用更小的chunk，减少单次处理时间
- 在资源充足时可以使用更大的chunk，提高效率
- 更好地适应多服务并发运行的情况

### 3. 其他已有优化

- 减少sleep时间: 0.1秒 → 0.01秒，提高响应速度
- 定期清理token列表: 避免列表过长导致切片操作变慢
- 优化内存管理: 及时清理已处理的token，释放内存

## 预期效果

1. **降低RTF**: 
   - 通过更小的chunk和自适应调整，在资源竞争时减少单次处理时间
   - 文本分割优化使得chunk更符合句子边界，减少不必要的处理

2. **提高语音质量**:
   - 按句子边界分割，避免打断一句话
   - 更自然的语音流

3. **更好的资源利用**:
   - 自适应chunk大小可以根据实际资源情况动态调整
   - 在多服务并发时自动降低chunk大小，减少资源竞争

## 使用建议

1. **监控RTF**: 观察优化后的RTF是否稳定在1以下
2. **调整参数**: 如果RTF仍然较高，可以进一步减小`token_max_n`和`token_min_n`
3. **资源监控**: 观察chunk大小的自适应调整是否正常工作

## 注意事项

- 自适应chunk大小调整需要处理几个chunk后才能生效（至少3次）
- 如果RTF仍然较高，可以考虑：
  - 进一步减小`token_max_n`和`token_min_n`
  - 调整自适应chunk大小的阈值（0.1秒和0.05秒）
  - 减小最小chunk大小（当前是`token_hop_len // 2`）
